<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <record id="view_sponsorship_contract_form_compassion" model="ir.ui.view">
            <field name="name">sponsorship.contract.compassion.form</field>
            <field name="model">recurring.contract</field>
            <field name="inherit_id" ref="contract_compassion.view_recurring_contract_form_compassion"/>
            <field name="arch" type="xml">
                <!-- Add correspondant field for sponsorships -->
                <field name="partner_id" position="after">
                    <field name="correspondant_id" options="{'create': false, 'm2o_dialog': false}" attrs="{'invisible':[('type', '!=', 'S')]}"/>
                </field>
                
                <!-- Redefine change method of parnter_id -->
                <xpath expr="//field[@name='partner_id']" position="attributes">
                    <attribute name="on_change" position="replace">
                        <attribute name="on_change">on_change_partner_id(partner_id, type)</attribute>
                    </attribute>
                </xpath>
                
                <!-- Make origin mandatory for sponsorships -->
                <field name="origin_id" position="attributes">
                    <attribute name="attrs">{'required':[('type', '=', 'S')]}</attribute>
                </field>
                
                <!-- Special types behaviours -->
                <xpath expr="//field[@name='type']" position="attributes">
                    <!-- Sponsorship contracts cannot change their types -->
                    <attribute name="attrs">{'readonly': [('type', '=', 'S')]}</attribute>
                </xpath>
                
                <!-- Field child_id is not available for general contracts -->
                <xpath expr="//field[@name='child_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('type', '!=', 'S')], 'required': [('type', '=', 'S')]}</attribute>
                </xpath>
                
                <!-- Add context in contract lines -->
                <xpath expr="//field[@name='contract_line_ids']" position="attributes">
                    <attribute name="context">{'default_type': type}</attribute>
                </xpath>
                
                <!-- Automatic birthday invoice -->
                <field name="next_invoice_date" position="after">
                    <field name="birthday_invoice"
                           attrs="{'invisible': ['|', ('state', 'in', ['terminated', 'cancelled']), ('type', '!=', 'S')]}"/>
                </field>
                
                <!-- Add context for group view -->
                <field name="group_id" position="attributes">
                    <attribute name="context">{'default_type': context.get('default_type'), 'default_partner_id': partner_id}</attribute>
                </field>
            </field>
        </record>

        <record id="view_compassion_contract_line_tree" model="ir.ui.view">
            <field name="name">compassion.contract.line.tree</field>
            <field name="model">recurring.contract.line</field>
            <field name="inherit_id" ref="recurring_contract.view_recurring_contract_line_tree" />
            <field name="arch" type="xml">
                <field name="product_id" position="attributes">
                    <attribute name="options">
                        {'colors':{'Sponsorship':'blue', 'Fund':'green', 'Sponsor gifts':'blueviolet'}, 'field_color':'categ_name'}
                    </attribute>
                </field>
                <field name="product_id" position="after">
                    <!-- Ability to link gift contract lines to sponsorships -->
                    <field name="sponsorship_id"
                           domain="[('partner_id', '=', parent.partner_id), ('type', '=', 'S'), ('state', 'not in', ['draft', 'terminated', 'cancelled'])]"/>
                </field>
            </field>
        </record>

        <record model="ir.actions.act_window" id="contract_compassion.action_contract">
            <field name="name">Other contracts</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">recurring.contract</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('type','in',['O','G'])]</field>
            <field name="context">{'default_type':'O'}</field>
        </record>

        <record id="action_sponsorship_contract" model="ir.actions.act_window">
            <field name="name">Sponsorships</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">recurring.contract</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('type','=','S')]</field>
            <field name="context">{'default_type':'S'}</field>
        </record>

        <!-- Move the Sponsorships Menu to the Sponsorship Section -->
        <menuitem id="menu_sponsorship_contract_form" parent="child_compassion.menu_sponsorship_section"
                  name="Sponsorships" sequence="0" action="action_sponsorship_contract"/>
        <menuitem id="contract_compassion.menu_contracts_section" parent="child_compassion.menu_sponsorship_root" 
                  name="Invoicing" groups="account.group_account_user" sequence="2"/>
        <menuitem id="open_customers" parent="child_compassion.menu_sponsorship_section"
                  name="Partners" action="base.action_partner_customer_form" sequence="3"/>
    </data>
</openerp>
