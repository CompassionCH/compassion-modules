<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2015 Compassion (http://www.compassion.ch)
    @author David Coninckx <david@coninckx.com>
    The licence is in the file __openerp__.py
-->
<openerp>
	<data>
        <record id="view_tracking_contract_form" model="ir.ui.view">
			<field name="name">follow.contract.compassion.form</field>
			<field name="model">recurring.contract</field>
            <field name="inherit_id" ref="recurring_contract.view_recurring_contract_form"/>
			<field name="arch" type="xml">
                <div class="oe_title" position="before">
                    <div class="oe_right oe_button_box" name="button_box">
                        <button name="switch_contract_view" 
                                type="object" 
                                string="Switch view" context="{'view_id':'view_follow_contract_form_compassion'}" />
                    </div>
                </div>
            </field>
        </record>
        
        <record id="view_follow_contract_form_compassion" model="ir.ui.view">
			<field name="name">follow.contract.compassion.form</field>
			<field name="model">recurring.contract</field>
			<field name="arch" type="xml">
                <form string="Follow contract" version="7.0" create="false" edit="false">
                    <header>
                        <field name="sds_state" widget="statusbar" statusbar_visible="draft,start,waiting_welcome,active,sub,sub_accept"/>
                        <button name="contract_validated" class="oe_highlight" attrs="{'invisible':[('sds_state','!=','draft')]}" string="Validate"/>
                        <button name="%(sponsorship_compassion.action_end_sponsorship)d" class="oe_highlight" string="Terminate" states="waiting,mandate,active" type="action"/>
                        <button name="mail_sent" class="oe_highlight" string="Mail sent" attrs="{'invisible':[('sds_state','!=','start')]}"/>
                        <button name="welcome_sent" class="oe_highlight" string="Welcome sent" attrs="{'invisible':[('sds_state','!=','waiting_welcome')]}"/>
                        <button name="no_sub" class="oe_highlight" string="No sub" attrs="{'invisible':[('sds_state','!=','sub_waiting')]}"/>
                        <button 
                            name="project_mail_sent" 
                            class="oe_highlight" 
                            string="Inform project status" 
                            attrs="{'invisible':[('project_state','not in',['inform_suspended', 'inform_suspended_reactivation', 'inform_reactivation', 'inform_project_terminated'])]}"/>
                        <button 
                            name="attribute" 
                            class="oe_highlight" 
                            string="Attributed" 
                            attrs="{'invisible':[('project_state','!=','waiting_attribution')]}"/>
                    </header>
                    <sheet>
                        <div class="oe_right oe_button_box" name="button_box">
							<button name="switch_contract_view" 
                                    type="object" 
                                    string="Switch view" 
                                    context="{'view_id':'view_tracking_contract_form'}"/>
						</div>
                        <div class="oe_title">
                            <h1><field name="name"/></h1>
                        </div>
                        <group>
                            <group>
                                <field name="partner_id"/>
                                <field name="correspondant_id"/>
                                <field name="parent_id"/>
                            </group>
                            <group>
                                <field name="origin_id"/>
                                <field name="channel"/>
                                <field name="attribution_instructions"/>
                            </group>

                            <group>
                                <field name="start_date"/>
                                <field name="activation_date"/>
                                <field name="last_sds_state_change_date"/>
                                <field name="end_date"/>
                            </group>
                            <group>
                                <field name="child_id"/>
                                <field name="end_reason"/>
                                <field name="state"/>
                                <field name="project_state"/>
                            </group>
                        </group>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
			</field>
		</record>

        <record id="view_follow_contract_tree_compassion" model="ir.ui.view">
			<field name="name">follow.contract.compassion.tree</field>
			<field name="model">recurring.contract</field>
			<field name="arch" type="xml">
                <tree string="Follow contracts" create="false" 
                    colors ="blue:sds_state == 'draft';red:sds_state == 'start';green:sds_state == 'waiting_welcome';black:sds_state == 'active';gray:state in ('cancelled')">
                    <field name="partner_codega"/>
                    <field name="partner_id"/>
                    
                    <field name="child_code"/>
                    <field name="child_name"/>
                    
                    <field name="start_date"/>
                    <field name="last_sds_state_change_date"/>
                    <field name="end_date"/>
                    <field name="origin_id"/>
                    <field name="state"/>
                    <field name="project_state"/>
                    <field name="sds_state"/>
                </tree>
			</field>
		</record>

        <!-- Filters -->
        <record id="contract_tracking_filter" model="ir.ui.view">
			<field name="name">contract.tracking.select</field>
			<field name="model">recurring.contract</field>
			<field name="arch" type="xml">
                <search string="Search contracts">
                    <field name="reference"/>
                    <field name="child_id"/>
                    <field name="partner_id"/>
                    <field name="sds_state"/>

                    <filter name="biennial" string="Biennial" domain="[('gmc_state', 'in', ('picture', 'casestudy'))]" context="{'group_by': 'gmc_state'}"/>
                    <filter name="depart" string="Departure" domain="[('gmc_state', '=', 'depart')]"/>
                    <filter name="transfer" string="Child Transfer" domain="[('gmc_state', '=', 'transfer')]"/>
                    <filter name="suspension" string="Project Suspended" domain="[('gmc_state', '=', 'suspension')]"/>
                    <filter name="reactivation" string="Project Reactivated" domain="[('gmc_state', '=', 'reactivation')]"/>

                    <group expand="0" string="Group By...">
                        <filter string="Start date" domain="[]"  context="{'group_by':'start_date'}"/>
                        <filter string="End date" domain="[]" context="{'group_by':'end_date'}"/>
                        <filter string="Welcome due date" domain="[]" context="{'group_by':'date_welcome'}"/>
                        <filter string="Sub date" domain="[]" context="{'group_by':'date_sub'}"/>
                        <filter string="Status" domain="[]"  context="{'group_by':'state'}"/>
                        <filter string="SDS Status" domain="[]"  context="{'group_by':'sds_state'}"/>
                        <filter string="Project Status" domain="[]"  context="{'group_by':'project_state'}"/>
                    </group>
                </search>
            </field>
		</record>
        
        <record model="ir.actions.act_window" id="action_follow_contract">
            <field name="name">Track contracts</field>
            <field name="res_model">recurring.contract</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="contract_tracking_filter"/>
        </record>

        <record model="ir.actions.act_window.view" id="act_follow_contract_tree">
            <field eval="1" name="sequence"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="view_follow_contract_tree_compassion"/>
            <field name="act_window_id" ref="action_follow_contract"/>
        </record>

        <record model="ir.actions.act_window.view" id="act_follow_contract_form">
            <field eval="2" name="sequence"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="view_follow_contract_form_compassion"/>
            <field name="act_window_id" ref="action_follow_contract"/>
        </record>

        <menuitem action="action_follow_contract" id="recurring_contract.menu_follow_contract" parent="child_compassion.menu_sponsorship_section"
                  name="Track sponsorships" sequence="0"/>
	</data>
</openerp>
